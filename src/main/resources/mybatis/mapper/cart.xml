<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.webteam1.oti.dao.CartDao">
    <!-- 
    cart
   	장바구니 등록 : 세션이 null(비회원)일 때 ckid(쿠키아이디)를 insert하고, 
   	세션이 null이 아닐 때 user_user_id를 insert 한다
   	-->
	<insert id="cartInsert" parameterType="Cart">
		insert into cart (cart_no, cart_qty, productOption_productOption_no, 
			cart_optionContent, product_product_no, cart_createdDate, cart_cklimit,
		<if test="cart_isLogin == 0">
			cart_ckId 
		</if>
		<if test="cart_isLogin != 0">
			users_users_id
		</if>
			)values(
				(select NVL(MAX(cart_no)+1,0)from cart),
				 #{cart_qty},
				 #{productOption_productOption_no}, 
				 #{cart_optionContent},
				 #{product_product_no},
				 sysdate,
				 sysdate+1
			<if test="cart_isLogin == 0">
				,#{cart_ckId}
			</if>
			<if test="cart_isLogin != 0">
				,#{users_users_id}
			</if>
			)
	</insert>
	
	<!-- 로그인시 비회원에서 회원 장바구니로 update -->
	<update id="cartUpdate" parameterType="Cart">
		update cart set users_users_id=#{users_users_id} where cart_ckId=#{cart_ckId}
	</update>
	
	<!-- 중복된 상품이 있는지 검사하기 위함 -->
	<select id="cartCheck" parameterType="Cart"  resultType="int">
		select count(*)
		from cart
		where cart_ckId=#{cart_ckId} and productOption_productOption_no =#{productOption_productOption_no}	
	</select>
	
	<!-- 선택한 옵션의 옵션 번호 얻기 -->
	<select id="selectOptionNo" parameterType="Map" resultType="int">
		select productOption_no
		from productOption
		where productOption_type=#{cart_optionContent} and product_product_no=#{product_product_no}
	</select>	
	
	<!-- 쿠키가 생성된 카트 불러오기 -->
	<select id="selectByCkId" parameterType="String" resultType="Cart">
		select * from cart where cart_ckId=#{cart_ckId}
	</select>
	
	<!-- 장바구니 상품리스트 -->
	<select id="selectCartList" resultMap="Cart">
		select 
		from CART c left outer join PRODUCT p on c.product_product_no = p.product_no
		left outer join PRODUCTOPTION po c.productOption_productOption_no = po.productOption_no
		where 
		<if test="cart_isLogin == 0">
			cart_ckid = #{cart_ckid}
		</if>
		<if test="cart_isLogin != 0">
			users_users_id = #{users_users_id}
		</if>
	</select>
	
	<resultMap type="Cart" id="Cart">
		<result column="CART_NO" property="cart_no" />
		<result column="USERS_USERS_ID" property="users_users_id"/>
		<result column="PRODUCT_PRODUCT_NO" property="product_product_no" />
		<result column="PRODUCTOPTION_PRODUCTOPTION_NO" property="productOption_productOption_no" />
		<result column="CART_OPTIONCONTENT" property="cart_optionContent" />
		<collection property="product_product_no" resultMap="Product"></collection>
		<collection property="productOption_productOption_no" resultMap="ProductOption"></collection>
	</resultMap>
	
	<resultMap type="Product" id="Product">
		<result column="PRODUCT_NO" property="product_no" />
		<result column="PRODUCT_NAME" property="product_name" />
		<result column="PRODUCT_STATUS" property="product_status" />
		<result column="PRODUCT_PRICE" property="product_price" />
		<result column="PRODUCT_QTY" property="product_qty" />
		<result column="PRODUCT_CREATEDDATE" property="product_createdDate" />
		<result column="PRODUCT_DETAIL" property="product_detail" />
		<result column="PRODUCT_HITCOUNT" property="product_hitcount" />
		<result column="PRODUCT_DISCOUNTRATE" property="product_discountRate" />
		<result column="PRODUCT_IMGFILE" property="product_imgFile" />
		<result column="PRODUCT_IMG" property="product_img" />
	</resultMap>
	
	<resultMap type="ProductOption" id="ProductOption">
		<result column="PRODUCTOPTION_NO" property="productOption_no" />
		<result column="PRODUCT_PRODUCT_NO" property="product_product_no" />
		<result column="PRODUCTOPTION_TYPE" property="productOtion_type" />
	</resultMap>
</mapper>