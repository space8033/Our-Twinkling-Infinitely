<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.webteam1.oti.dao.CartDao">
    <!-- 
    cart
   	장바구니 등록 : 세션이 null(비회원)일 때 ckid(쿠키아이디)를 insert하고, 
   	세션이 null이 아닐 때 user_user_id를 insert 한다
   	-->
	<insert id="cartInsert" parameterType="Cart">
		insert into cart (cart_no, cart_qty, productOption_productOption_no, 
			cart_optionContent, product_product_no, cart_createdDate, cart_cklimit,
		<if test="cart_isLogin == 0">
			cart_ckId 
		</if>
		<if test="cart_isLogin != 0">
			users_users_id
		</if>
			)values(
				(select NVL(MAX(cart_no)+1,0)from cart),
				 #{cart_qty},
				 #{productOption_productOption_no}, 
				 #{cart_optionContent},
				 #{product_product_no},
				 sysdate,
				 sysdate+1
			<if test="cart_isLogin == 0">
				,#{cart_ckId}
			</if>
			<if test="cart_isLogin != 0">
				,#{users_users_id}
			</if>
			)
	</insert>
	
	<!-- 로그인시 비회원에서 회원 장바구니로 update -->
	<update id="cartUpdate" parameterType="Cart">
		update cart set users_users_id=#{users_users_id} where cart_ckId=#{cart_ckId}
	</update>
	
	<!-- 중복된 상품이 있는지 검사하기 위함 -->
	<select id="cartCheck" parameterType="Cart"  resultType="int">
		select count(*)
		from cart
		where cart_ckId=#{cart_ckId} and productOption_productOption_no =#{productOption_productOption_no}	
	</select>
	
	<!-- 선택한 옵션의 옵션 번호 얻기 -->
	<select id="selectOptionNo" parameterType="Map" resultType="int">
		select productOption_no
		from productOption
		where productOption_type=#{cart_optionContent} and product_product_no=#{product_product_no}
	</select>	
	
	<!-- 쿠키가 생성된 카트 불러오기 -->
	<select id="selectByCkId" parameterType="String" resultType="Cart">
		select * from cart where cart_ckId=#{cart_ckId}
	</select>
	
	<!-- 장바구니 추가한 상품리스트 불러오기-->
	<select id="selectCartList" parameterType="Cart" resultType="CartDto">
		select  c.cart_no, c.productOption_productOption_no, c.cart_optionContent, c.cart_qty, p.product_no,
		p.product_name , p.product_price ,p.product_imgFile, o.productOption_no , o.productOption_type
		from CART c 
		left outer join PRODUCT p on c.product_product_no = p.product_no 
		left outer join PRODUCTOPTION o on c.productOption_productOption_no = o.productOption_no
		<where>		
			<if test="users_users_id == null">
				cart_ckid = #{cart_ckId}
			</if>
			<if test="users_users_id != null">
				users_users_id = #{users_users_id}
			</if>
		</where>
	</select>
</mapper>